apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../../../base/microservices/user-service

namespace: microservices

# Use modern 'labels' instead of deprecated 'commonLabels'
labels:
  - pairs:
      app: user-service
      component: microservices
      environment: dev

images:
  - name: yahyazakaria123/ecommerce-app-user-service
    newTag: latest

replicas:
  - name: user-service
    count: 1

# Modern patches approach
patches:
  # Deployment patches for dev environment
  - patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: user-service
        annotations:
          deployment.kubernetes.io/revision: "1"
      spec:
        template:
          spec:
            containers:
              - name: user-service
                env:
                  - name: SPRING_PROFILES_ACTIVE
                    value: "dev,docker,kafka"
                  - name: LOGGING_LEVEL_ROOT
                    value: "DEBUG"
                resources:
                  requests:
                    memory: "512Mi"
                    cpu: "200m"
                  limits:
                    memory: "1Gi"
                    cpu: "500m"
    target:
      group: apps
      version: v1
      kind: Deployment
      name: user-service

  # Service patch for dev environment (NodePort for external access)
  - patch: |
      apiVersion: v1
      kind: Service
      metadata:
        name: user-service
      spec:
        type: NodePort
        ports:
          - name: http
            port: 8081
            targetPort: 8081
            nodePort: 30081
            protocol: TCP
    target:
      version: v1
      kind: Service
      name: user-service

# Generate additional config for dev
configMapGenerator:
  - name: user-service-dev-config
    literals:
      - SPRING_PROFILES_ACTIVE=dev,docker,kafka
      - LOG_LEVEL=DEBUG
      - EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE=http://eureka-server.infrastructure.svc.cluster.local:8761/eureka
      - SPRING_CLOUD_CONFIG_URI=http://config-server.infrastructure.svc.cluster.local:8888