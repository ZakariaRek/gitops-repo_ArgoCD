apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: user-mongodb-dev
  namespace: data

# Reference the base user-mongodb configuration
resources:
  - ../../../../../base/data/mongodb/user-mongodb

# Use data namespace
namespace: data

# Add environment-specific labels
labels:
  - pairs:
      environment: dev
      tier: development

# Use development image tag
images:
  - name: mongo
    newTag: "7.0"

# Reduce replicas for dev (save resources)
replicas:
  - name: user-mongodb
    count: 1

# Generate additional ConfigMap with dev-specific settings
configMapGenerator:
  - name: user-mongodb-dev-config
    literals:
      - MONGO_LOG_LEVEL=info        # Changed from debug to reduce noise
      - MONGO_SLOW_OP_THRESHOLD=1000  # Increased threshold
      - ENVIRONMENT=development

# Use patches to modify existing resources
patches:
  # Patch the secret with dev credentials
  - patch: |-
      apiVersion: v1
      kind: Secret
      metadata:
        name: user-mongodb-secret
      data:
        username: dXNlcnNlcnZpY2VfZGV2  # userservice_dev (base64)
        password: dXNlcnNlcnZpY2VfZGV2XzEyMw==  # userservice_dev_123 (base64)
    target:
      kind: Secret
      name: user-mongodb-secret

  # Patch StatefulSet for dev resources and single replica with better startup handling
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: user-mongodb
      spec:
        template:
          spec:
            nodeSelector:
              node-role: data
            containers:
              - name: mongodb
                resources:
                  requests:
                    memory: "512Mi"    # Increased from 256Mi
                    cpu: "250m"        # Increased from 100m
                  limits:
                    memory: "1Gi"      # Increased from 512Mi
                    cpu: "500m"        # Increased from 250m
                # More lenient probes for dev environment
                startupProbe:
                  tcpSocket:
                    port: 27017
                  initialDelaySeconds: 45    # Longer initial delay
                  periodSeconds: 15          # Longer period
                  timeoutSeconds: 10
                  failureThreshold: 40       # More failures allowed (10 minutes)
                readinessProbe:
                  exec:
                    command:
                      - bash
                      - -c
                      - |
                        mongosh --username $MONGO_INITDB_ROOT_USERNAME --password $MONGO_INITDB_ROOT_PASSWORD --authenticationDatabase admin --eval "db.adminCommand('ping')" --quiet
                  initialDelaySeconds: 90    # Much longer for dev
                  periodSeconds: 20
                  timeoutSeconds: 25
                  failureThreshold: 6
                livenessProbe:
                  exec:
                    command:
                      - bash
                      - -c
                      - |
                        mongosh --username $MONGO_INITDB_ROOT_USERNAME --password $MONGO_INITDB_ROOT_PASSWORD --authenticationDatabase admin --eval "db.adminCommand('ping')" --quiet
                  initialDelaySeconds: 150   # Much longer for dev
                  periodSeconds: 40
                  timeoutSeconds: 25
                  failureThreshold: 3
    target:
      kind: StatefulSet
      name: user-mongodb

  # Update ConfigMap for dev database
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: user-mongodb-config
      data:
        database-name: "userdb_dev"
        mongodb-url: "mongodb://user-mongodb-headless.data.svc.cluster.local:27017/userdb_dev"
    target:
      kind: ConfigMap
      name: user-mongodb-config