
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: cart-mongodb-dev
  namespace: data

# Reference the base cart-mongodb configuration
resources:
  - ../../../../../base/data/mongodb/cart-mongodb
  - nodeport-service.yaml

# Use data namespace
namespace: data

# Add environment-specific labels
labels:
  - pairs:
      environment: dev
      tier: development

# Use development image tag
images:
  - name: mongo
    newTag: "7.0"

# Reduce replicas for dev (save resources)
replicas:
  - name: cart-mongodb
    count: 1

# Generate additional ConfigMap with dev-specific settings
configMapGenerator:
  - name: cart-mongodb-dev-config
    literals:
      - MONGO_LOG_LEVEL=debug
      - MONGO_SLOW_OP_THRESHOLD=100
      - ENVIRONMENT=development

# Use patches to modify existing resources
patches:
  # Patch the secret with dev credentials
  - patch: |-
      apiVersion: v1
      kind: Secret
      metadata:
        name: cart-mongodb-secret
      data:
        username: Y2FydHNlcnZpY2VfZGV2  # cartservice_dev (base64)
        password: Y2FydHNlcnZpY2VfZGV2XzEyMw==  # cartservice_dev_123 (base64)
    target:
      kind: Secret
      name: cart-mongodb-secret

  # Patch StatefulSet for dev resources and single replica
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: cart-mongodb
      spec:
        template:
          spec:
            containers:
              - name: mongodb
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "250m"
    target:
      kind: StatefulSet
      name: cart-mongodb

  # Update ConfigMap for dev database
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cart-mongodb-config
      data:
        database-name: "cartdb_dev"
        mongodb-url: "mongodb://cart-mongodb-headless.data.svc.cluster.local:27017/cartdb_dev"
    target:
      kind: ConfigMap
      name: cart-mongodb-config

#  # For dev, we only need PVs for replica 0 since replicas=1
#  # Remove the unused PVs to avoid resource waste
#  - patch: |-
#      $patch: delete
#    target:
#      kind: PersistentVolume
#      name: cart-mongodb-data-pv-1
#
#  - patch: |-
#      $patch: delete
#    target:
#      kind: PersistentVolume
#      name: cart-mongodb-config-pv-1