# environments/dev/data/mongodb/cart-mongodb/health-check-patch.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: cart-mongodb-dev
  namespace: data

# Reference the base cart-mongodb configuration
resources:
  - ../../../../../base/data/mongodb/cart-mongodb
  - nodeport-service.yaml

# Use data namespace
namespace: data

# Add environment-specific labels
labels:
  - pairs:
      environment: dev
      tier: development

# Use development image tag
images:
  - name: mongo
    newTag: "7.0"

# Reduce replicas for dev (save resources)
replicas:
  - name: cart-mongodb
    count: 1

# Generate additional ConfigMap with dev-specific settings
configMapGenerator:
  - name: cart-mongodb-dev-config
    literals:
      - MONGO_LOG_LEVEL=info  # Reduced from debug to avoid noise
      - MONGO_SLOW_OP_THRESHOLD=1000
      - ENVIRONMENT=development

# CRITICAL FIXES: Use patches to fix health check issues
patches:
  # Patch the secret with dev credentials
  - patch: |-
      apiVersion: v1
      kind: Secret
      metadata:
        name: cart-mongodb-secret
      data:
        username: Y2FydHNlcnZpY2U=  # cartservice (base64)
        password: Y2FydHNlcnZpY2UxMjM=  # cartservice123 (base64)
    target:
      kind: Secret
      name: cart-mongodb-secret

  # MAJOR FIX: Patch StatefulSet with proper health checks and resource limits
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: cart-mongodb
      spec:
        template:
          spec:
            nodeSelector:
              node-role: data
            containers:
              - name: mongodb
                # FIXED: Reduced resources for dev environment
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "250m"
                
                # FIXED: Environment variables for better MongoDB 7.0 compatibility
                env:
                  - name: MONGO_INITDB_ROOT_USERNAME
                    valueFrom:
                      secretKeyRef:
                        name: cart-mongodb-secret
                        key: username
                  - name: MONGO_INITDB_ROOT_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: cart-mongodb-secret
                        key: password
                  - name: MONGO_INITDB_DATABASE
                    valueFrom:
                      configMapKeyRef:
                        name: cart-mongodb-config
                        key: database-name
                  # CRITICAL: Disable problematic options for dev
                  - name: MONGO_INITDB_ARGS
                    value: "--auth"
                
                # FIXED: Much more lenient health checks for MongoDB 7.0
                startupProbe:
                  tcpSocket:
                    port: 27017
                  initialDelaySeconds: 60    # Much longer startup time
                  periodSeconds: 15
                  timeoutSeconds: 10
                  failureThreshold: 20       # Allow 5+ minutes for startup
                
                readinessProbe:
                  tcpSocket:
                    port: 27017              # Use TCP instead of mongosh for dev
                  initialDelaySeconds: 90
                  periodSeconds: 15
                  timeoutSeconds: 10
                  failureThreshold: 5
                
                livenessProbe:
                  tcpSocket:
                    port: 27017              # Use TCP instead of mongosh for dev
                  initialDelaySeconds: 180   # Very long delay for liveness
                  periodSeconds: 30
                  timeoutSeconds: 10
                  failureThreshold: 3
    target:
      kind: StatefulSet
      name: cart-mongodb

  # Update ConfigMap for dev database
  - patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cart-mongodb-config
      data:
        database-name: "cartdb"  # Keep simple name for dev
        mongodb-url: "mongodb://cart-mongodb-headless.data.svc.cluster.local:27017/cartdb"
        # FIXED: Simplified MongoDB config for dev
        mongod.conf: |
          storage:
            dbPath: /data/db
            journal:
              enabled: true
          systemLog:
            destination: file
            logAppend: true
            path: /var/log/mongodb/mongod.log
            logRotate: reopen
            verbosity: 0  # Reduced verbosity for dev
          net:
            port: 27017
            bindIp: 0.0.0.0
            maxIncomingConnections: 50  # Reduced for dev
          processManagement:
            timeZoneInfo: /usr/share/zoneinfo
          # REMOVED: Replication settings for single-node dev setup
          # REMOVED: Complex security settings for dev simplicity
    target:
      kind: ConfigMap
      name: cart-mongodb-config

  # OPTIONAL: Patch volumeClaimTemplates for smaller dev storage
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: cart-mongodb
      spec:
        volumeClaimTemplates:
          - metadata:
              name: mongodb-data
            spec:
              resources:
                requests:
                  storage: 2Gi  # Much smaller for dev
          - metadata:
              name: mongodb-config
            spec:
              resources:
                requests:
                  storage: 500Mi  # Much smaller for dev
    target:
      kind: StatefulSet
      name: cart-mongodb