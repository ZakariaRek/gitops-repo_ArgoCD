apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

metadata:
  name: data-layer-dev
  namespace: data

# Reference the base data layer configuration
resources:
  - ../../../base/data
  - ../../../tools/kafka-ui
  - kafka-ui-ingress.yaml
# Use data namespace
namespace: data

# Add environment-specific labels
labels:
  - pairs:
      environment: dev
      tier: development

# Use development image tags
images:
  - name: confluentinc/cp-kafka
    newTag: 7.4.0
  - name: confluentinc/cp-zookeeper
    newTag: 7.4.0
  - name: provectuslabs/kafka-ui
    newTag: latest

# Reduce replicas for dev (save resources)
replicas:
  - name: kafka
    count: 1
  - name: zookeeper
    count: 1
  - name: kafka-ui
    count: 1


# Generate additional ConfigMap with dev-specific settings
configMapGenerator:
  - name: kafka-dev-config
    literals:
      - KAFKA_LOG_RETENTION_HOURS=24
      - KAFKA_DEFAULT_REPLICATION_FACTOR=1
      - KAFKA_AUTO_CREATE_TOPICS_ENABLE=true
      - ZOOKEEPER_LOG4J_ROOT_LOGLEVEL=DEBUG

# Use the new patches syntax for development-specific configurations
patches:
  # Kafka development patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: kafka
        namespace: data
      spec:
        template:
          spec:
            containers:
              - name: kafka
                env:
                  - name: KAFKA_LOG_RETENTION_HOURS
                    value: "24"  # Shorter retention for dev
                  - name: KAFKA_LOG_RETENTION_BYTES
                    value: "536870912"  # 512MB
                  - name: KAFKA_LOG_SEGMENT_BYTES
                    value: "134217728"  # 128MB
                  - name: KAFKA_HEAP_OPTS
                    value: "-Xmx512M -Xms512M"  # Smaller heap for dev
                resources:
                  requests:
                    memory: "512Mi"
                    cpu: "250m"
                  limits:
                    memory: "1Gi"
                    cpu: "500m"
    target:
      kind: Deployment
      name: kafka

  # Zookeeper development patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: zookeeper
        namespace: data
      spec:
        template:
          spec:
            containers:
              - name: zookeeper
                env:
                  - name: KAFKA_HEAP_OPTS
                    value: "-Xmx256M -Xms256M"  # Smaller heap for dev
                  - name: ZOOKEEPER_LOG4J_ROOT_LOGLEVEL
                    value: "DEBUG"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "100m"
                  limits:
                    memory: "512Mi"
                    cpu: "250m"
    target:
      kind: Deployment
      name: zookeeper

  # Kafka UI development patches
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: kafka-ui
        namespace: data
      spec:
        template:
          spec:
            containers:
              - name: kafka-ui
                env:
                  - name: LOGGING_LEVEL_ROOT
                    value: "DEBUG"
                  - name: LOGGING_LEVEL_COM_PROVECTUS
                    value: "DEBUG"
                resources:
                  requests:
                    memory: "128Mi"
                    cpu: "50m"
                  limits:
                    memory: "256Mi"
                    cpu: "200m"
    target:
      kind: Deployment
      name: kafka-ui

  # Patch PVCs for smaller storage in dev
  - patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: kafka-storage-pvc
        namespace: data
      spec:
        resources:
          requests:
            storage: 5Gi  # Smaller storage for dev
    target:
      kind: PersistentVolumeClaim
      name: kafka-storage-pvc

  - patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: zookeeper-data-pvc
        namespace: data
      spec:
        resources:
          requests:
            storage: 2Gi  # Smaller storage for dev
    target:
      kind: PersistentVolumeClaim
      name: zookeeper-data-pvc

  - patch: |-
      apiVersion: v1
      kind: PersistentVolumeClaim
      metadata:
        name: zookeeper-logs-pvc
        namespace: data
      spec:
        resources:
          requests:
            storage: 1Gi  # Smaller storage for dev
    target:
      kind: PersistentVolumeClaim
      name: zookeeper-logs-pvc

  # Patch services to use NodePort for dev access
  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: kafka-service
        namespace: data
      spec:
        type: NodePort
        ports:
          - name: kafka
            port: 9092
            targetPort: 9092
            nodePort: 30092
          - name: jmx
            port: 9997
            targetPort: 9997
            nodePort: 30997
    target:
      kind: Service
      name: kafka-service

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: zookeeper-service
        namespace: data
      spec:
        type: NodePort
        ports:
          - name: client
            port: 2181
            targetPort: 2181
            nodePort: 30181
          - name: follower
            port: 2888
            targetPort: 2888
            nodePort: 30288
          - name: election
            port: 3888
            targetPort: 3888
            nodePort: 30388
    target:
      kind: Service
      name: zookeeper-service

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: kafka-ui-service
        namespace: data
      spec:
        type: NodePort
        ports:
          - name: http
            port: 8080
            targetPort: 8080
            nodePort: 30880
    target:
      kind: Service
      name: kafka-ui-service