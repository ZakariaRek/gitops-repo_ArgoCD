apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: api-gateway-vs
  namespace: infrastructure
  labels:
    app: api-gateway
    component: istio-routing
spec:
  hosts:
    - "api.nexus-commerce.local"
  gateways:
    - istio-system/nexus-commerce-gateway
  http:
    - match:
        - uri:
            prefix: "/api/users"
      route:
        - destination:
            host: user-service.microservices.svc.cluster.local
            port:
              number: 8081
      fault:
        delay:
          percentage:
            value: 0.1
          fixedDelay: 5s
      retries:
        attempts: 3
        perTryTimeout: 10s
        retryOn: gateway-error,connect-failure,refused-stream

    - match:
        - uri:
            prefix: "/api/products"
      route:
        - destination:
            host: product-service.microservices.svc.cluster.local
            port:
              number: 8081
      retries:
        attempts: 3
        perTryTimeout: 10s

    - match:
        - uri:
            prefix: "/api/carts"
      route:
        - destination:
            host: cart-service.microservices.svc.cluster.local
            port:
              number: 8082
      retries:
        attempts: 3
        perTryTimeout: 15s

    - match:
        - uri:
            prefix: "/api/orders"
      route:
        - destination:
            host: order-service.microservices.svc.cluster.local
            port:
              number: 8082
      retries:
        attempts: 3
        perTryTimeout: 20s

    - match:
        - uri:
            prefix: "/api/payments"
      route:
        - destination:
            host: payment-service.microservices.svc.cluster.local
            port:
              number: 8084
      timeout: 30s
      retries:
        attempts: 2
        perTryTimeout: 30s
        retryOn: 5xx

    - match:
        - uri:
            prefix: "/api/shipping"
      route:
        - destination:
            host: shipping-service.microservices.svc.cluster.local
            port:
              number: 8082
      retries:
        attempts: 3
        perTryTimeout: 15s

    - match:
        - uri:
            prefix: "/api/loyalty"
      route:
        - destination:
            host: loyalty-service.microservices.svc.cluster.local
            port:
              number: 8084
      retries:
        attempts: 3
        perTryTimeout: 10s

    - match:
        - uri:
            prefix: "/api/notifications"
      route:
        - destination:
            host: notification-service.microservices.svc.cluster.local
            port:
              number: 8086
      retries:
        attempts: 3
        perTryTimeout: 10s

    # Default route to API Gateway
    - match:
        - uri:
            prefix: "/"
      route:
        - destination:
            host: api-gateway.infrastructure.svc.cluster.local
            port:
              number: 8099
      retries:
        attempts: 3
        perTryTimeout: 15s
      headers:
        request:
          add:
            x-forwarded-proto: https
        response:
          add:
            x-content-type-options: nosniff
            x-frame-options: DENY
